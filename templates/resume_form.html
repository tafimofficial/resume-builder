{% extends 'base.html' %}

{% block extra_css %}
<style>
    .delete-checkbox { display: none; }
    .remove-form-btn { cursor: pointer; }
    .remove-form-btn:hover { color: #dc3545 !important; }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="glass-card p-4 p-md-5 mb-5">
            <h2 class="mb-4 text-center">{{ title }}</h2>

            <!-- Tab Navigation -->
            <ul class="nav nav-tabs mb-4" id="resumeTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab" aria-controls="edit" aria-selected="true">
                    <i class="bi bi-pencil-square me-2"></i>Editor
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab" aria-controls="preview" aria-selected="false">
                    <i class="bi bi-eye me-2"></i>Live Preview
                </button>
              </li>
            </ul>

            <div class="tab-content" id="resumeTabsContent">
                <!-- Editor Tab -->
                <div class="tab-pane fade show active" id="edit" role="tabpanel" aria-labelledby="edit-tab">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        {{ resume_form.doc_type }}
                
                <h4 class="mb-3">Resume Settings</h4>
                <div class="row mb-4">
                    <div class="col-md-8">
                        {{ resume_form.title.label_tag }}
                        {{ resume_form.title }}
                    </div>
                    <div class="col-md-4">
                         {{ resume_form.template_name.label_tag }}
                         {{ resume_form.template_name }}
                    </div>
                </div>
                
                <hr class="my-4">

                <h4 class="mb-3">Personal Details</h4>
                <div class="row g-3">
                    <div class="col-md-12">
                        {{ personal_form.image.label_tag }}
                        {{ personal_form.image }}
                    </div>
                    <div class="col-md-6">
                        {{ personal_form.full_name.label_tag }}
                        {{ personal_form.full_name }}
                    </div>
                    <div class="col-md-6">
                        {{ personal_form.email.label_tag }}
                        {{ personal_form.email }}
                    </div>
                    <div class="col-md-6">
                        {{ personal_form.phone.label_tag }}
                        {{ personal_form.phone }}
                    </div>
                    <div class="col-md-6">
                        {{ personal_form.address.label_tag }}
                        {{ personal_form.address }}
                    </div>
                     <div class="col-md-6">
                        {{ personal_form.linkedin_url.label_tag }}
                        {{ personal_form.linkedin_url }}
                    </div>
                    <div class="col-md-6">
                        {{ personal_form.portfolio_url.label_tag }}
                        {{ personal_form.portfolio_url }}
                    </div>
                    <div class="col-12">
                         {{ personal_form.summary.label_tag }}
                         {{ personal_form.summary }}
                    </div>
                </div>

                <hr class="my-4">

                <h4 class="mb-3">Education</h4>
                {{ education_formset.management_form }}
                <div id="education-formset">
                    {% for form in education_formset %}
                        <div class="card mb-3 border-0 shadow-sm education-form">
                             <div class="card-body bg-light rounded">
                                {{ form.id }}
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0 text-muted">Education #<span class="entry-number">{{ forloop.counter }}</span></h5>
                                    <button type="button" class="btn btn-link text-secondary p-0 remove-form-btn" title="Remove">
                                        <i class="bi bi-x-circle-fill fs-5"></i> Remove
                                    </button>
                                </div>
                                <div class="delete-checkbox">{{ form.DELETE }}</div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        {{ form.institution.label_tag }}
                                        {{ form.institution }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.degree.label_tag }}
                                        {{ form.degree }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.start_date.label_tag }}
                                        {{ form.start_date }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.end_date.label_tag }}
                                        {{ form.end_date }}
                                    </div>
                                    <div class="col-md-4 d-flex align-items-center mt-4">
                                         <div class="form-check">
                                            {{ form.is_current }}
                                            <label class="form-check-label">Currently Studying</label>
                                         </div>
                                    </div>
                                     <div class="col-12">
                                        {{ form.description.label_tag }}
                                        {{ form.description }}
                                    </div>
                                </div>
                             </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-info btn-sm mb-4" id="add-education">Add Another Education</button>

                <hr class="my-4">

                <h4 class="mb-3">Experience</h4>
                 {{ experience_formset.management_form }}
                <div id="experience-formset">
                    {% for form in experience_formset %}
                         <div class="card mb-3 border-0 shadow-sm experience-form">
                             <div class="card-body bg-light rounded">
                                {{ form.id }}
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0 text-muted">Experience #<span class="entry-number">{{ forloop.counter }}</span></h5>
                                    <button type="button" class="btn btn-link text-secondary p-0 remove-form-btn" title="Remove">
                                        <i class="bi bi-x-circle-fill fs-5"></i> Remove
                                    </button>
                                </div>
                                <div class="delete-checkbox">{{ form.DELETE }}</div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        {{ form.company.label_tag }}
                                        {{ form.company }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.position.label_tag }}
                                        {{ form.position }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.start_date.label_tag }}
                                        {{ form.start_date }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.end_date.label_tag }}
                                        {{ form.end_date }}
                                    </div>
                                    <div class="col-md-4 d-flex align-items-center mt-4">
                                         <div class="form-check">
                                            {{ form.is_current }}
                                            <label class="form-check-label">Currently Working</label>
                                         </div>
                                    </div>
                                     <div class="col-12">
                                        {{ form.description.label_tag }}
                                        {{ form.description }}
                                    </div>
                                </div>
                             </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-info btn-sm mb-4" id="add-experience">Add Another Experience</button>

                <hr class="my-4">

                <h4 class="mb-3">Skills</h4>
                {{ skill_formset.management_form }}
                <div class="row" id="skill-formset">
                    {% for form in skill_formset %}
                         <div class="col-md-4 mb-3 skill-form">
                             <div class="card border-0 shadow-sm h-100">
                                 <div class="card-body bg-light rounded">
                                    {{ form.id }}
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted small">Skill #<span class="entry-number">{{ forloop.counter }}</span></span>
                                        <button type="button" class="btn btn-link text-secondary p-0 remove-form-btn" title="Remove">
                                            <i class="bi bi-x-circle fs-6"></i>
                                        </button>
                                    </div>
                                    <div class="delete-checkbox">{{ form.DELETE }}</div>
                                    <div class="mb-2">
                                        {{ form.name.label_tag }}
                                        {{ form.name }}
                                    </div>
                                     <div class="mb-2">
                                        {{ form.proficiency.label_tag }}
                                        {{ form.proficiency }}
                                    </div>
                                 </div>
                             </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-info btn-sm" id="add-skill">Add Another Skill</button>

                {% if doc_type == 'cv' %}
                <hr class="my-4">
                <h4 class="mb-3">Research</h4>
                {{ research_formset.management_form }}
                <div id="research-formset">
                    {% for form in research_formset %}
                        <div class="card mb-3 border-0 shadow-sm research-form">
                            <div class="card-body bg-light rounded">
                                {{ form.id }}
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0 text-muted">Research #<span class="entry-number">{{ forloop.counter }}</span></h5>
                                    <button type="button" class="btn btn-link text-secondary p-0 remove-form-btn" title="Remove">
                                        <i class="bi bi-x-circle-fill fs-5"></i> Remove
                                    </button>
                                </div>
                                <div class="delete-checkbox">{{ form.DELETE }}</div>
                                <div class="row g-3">
                                    <div class="col-md-8">
                                        {{ form.title.label_tag }}
                                        {{ form.title }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.date.label_tag }}
                                        {{ form.date }}
                                    </div>
                                    <div class="col-12">
                                        {{ form.description.label_tag }}
                                        {{ form.description }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-info btn-sm mb-4" id="add-research">Add Research Project</button>

                <hr class="my-4">
                <h4 class="mb-3">Publications</h4>
                {{ publication_formset.management_form }}
                <div id="publication-formset">
                    {% for form in publication_formset %}
                        <div class="card mb-3 border-0 shadow-sm publication-form">
                            <div class="card-body bg-light rounded">
                                {{ form.id }}
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0 text-muted">Publication #<span class="entry-number">{{ forloop.counter }}</span></h5>
                                    <button type="button" class="btn btn-link text-secondary p-0 remove-form-btn" title="Remove">
                                        <i class="bi bi-x-circle-fill fs-5"></i> Remove
                                    </button>
                                </div>
                                <div class="delete-checkbox">{{ form.DELETE }}</div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        {{ form.title.label_tag }}
                                        {{ form.title }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.publisher.label_tag }}
                                        {{ form.publisher }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.date.label_tag }}
                                        {{ form.date }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.url.label_tag }}
                                        {{ form.url }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-info btn-sm mb-4" id="add-publication">Add Publication</button>

                <hr class="my-4">
                <h4 class="mb-3">Awards & Honors</h4>
                {{ award_formset.management_form }}
                <div id="award-formset">
                    {% for form in award_formset %}
                        <div class="card mb-3 border-0 shadow-sm award-form">
                            <div class="card-body bg-light rounded">
                                {{ form.id }}
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0 text-muted">Award #<span class="entry-number">{{ forloop.counter }}</span></h5>
                                    <button type="button" class="btn btn-link text-secondary p-0 remove-form-btn" title="Remove">
                                        <i class="bi bi-x-circle-fill fs-5"></i> Remove
                                    </button>
                                </div>
                                <div class="delete-checkbox">{{ form.DELETE }}</div>
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        {{ form.title.label_tag }}
                                        {{ form.title }}
                                    </div>
                                    <div class="col-md-6">
                                        {{ form.issuer.label_tag }}
                                        {{ form.issuer }}
                                    </div>
                                    <div class="col-md-4">
                                        {{ form.date.label_tag }}
                                        {{ form.date }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-outline-info btn-sm mb-4" id="add-award">Add Award</button>
                {% endif %}

                <div class="d-grid mt-5">
                    <button type="submit" class="btn btn-primary btn-lg text-white">Save {{ doc_type|upper }}</button>
                    <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary mt-2">Cancel</a>
                </div>
            </form>
        </div>
        
        <!-- Preview Tab -->
        <div class="tab-pane fade" id="preview" role="tabpanel" aria-labelledby="preview-tab">
            <div class="alert alert-info mt-3">
                <i class="bi bi-info-circle me-2"></i> Save your changes first to see them reflected in the preview. Select a template in the Editor tab to change the look.
            </div>
            {% if resume_form.instance.pk %}
            <!-- JS will update this iframe src when template changes -->
            <div class="ratio" style="height: 1000px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden; --bs-aspect-ratio: 140%;">
                <iframe src="{% url 'view_resume' resume_form.instance.pk %}?template={{ resume_form.instance.template_name }}" id="previewFrame" style="width: 100%; height: 100%; border: none;"></iframe>
            </div>
            {% else %}
            <div class="text-center p-5">
                <h4>Please save your resume first to generate a preview.</h4>
            </div>
            {% endif %}
        </div>
    </div>
        </div>
    </div>
</div>

<div id="education-empty-form" style="display: none;">
    <div class="card mb-3 border-0 shadow-sm education-form">
        <div class="card-body bg-light rounded">
            {{ education_formset.empty_form.id }}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-muted">Education #<span class="entry-number">__number__</span></h5>
                <button type="button" class="btn btn-link text-secondary p-0 remove-form-btn" title="Remove">
                    <i class="bi bi-x-circle-fill fs-5"></i> Remove
                </button>
            </div>
            <div class="delete-checkbox">{{ education_formset.empty_form.DELETE }}</div>
            <div class="row g-3">
                <div class="col-md-6">
                    {{ education_formset.empty_form.institution.label_tag }}
                    {{ education_formset.empty_form.institution }}
                </div>
                <div class="col-md-6">
                    {{ education_formset.empty_form.degree.label_tag }}
                    {{ education_formset.empty_form.degree }}
                </div>
                <div class="col-md-4">
                    {{ education_formset.empty_form.start_date.label_tag }}
                    {{ education_formset.empty_form.start_date }}
                </div>
                <div class="col-md-4">
                    {{ education_formset.empty_form.end_date.label_tag }}
                    {{ education_formset.empty_form.end_date }}
                </div>
                <div class="col-md-4 d-flex align-items-center mt-4">
                     <div class="form-check">
                        {{ education_formset.empty_form.is_current }}
                        <label class="form-check-label">Currently Studying</label>
                     </div>
                </div>
                 <div class="col-12">
                    {{ education_formset.empty_form.description.label_tag }}
                    {{ education_formset.empty_form.description }}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="experience-empty-form" style="display: none;">
    <div class="card mb-3 border-0 shadow-sm experience-form">
        <div class="card-body bg-light rounded">
            {{ experience_formset.empty_form.id }}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-muted">Experience #<span class="entry-number">__number__</span></h5>
                <button type="button" class="btn btn-link text-secondary p-0 remove-form-btn" title="Remove">
                    <i class="bi bi-x-circle-fill fs-5"></i> Remove
                </button>
            </div>
            <div class="delete-checkbox">{{ experience_formset.empty_form.DELETE }}</div>
            <div class="row g-3">
                <div class="col-md-6">
                    {{ experience_formset.empty_form.company.label_tag }}
                    {{ experience_formset.empty_form.company }}
                </div>
                <div class="col-md-6">
                    {{ experience_formset.empty_form.position.label_tag }}
                    {{ experience_formset.empty_form.position }}
                </div>
                <div class="col-md-4">
                    {{ experience_formset.empty_form.start_date.label_tag }}
                    {{ experience_formset.empty_form.start_date }}
                </div>
                <div class="col-md-4">
                    {{ experience_formset.empty_form.end_date.label_tag }}
                    {{ experience_formset.empty_form.end_date }}
                </div>
                <div class="col-md-4 d-flex align-items-center mt-4">
                     <div class="form-check">
                        {{ experience_formset.empty_form.is_current }}
                        <label class="form-check-label">Currently Working</label>
                     </div>
                </div>
                 <div class="col-12">
                    {{ experience_formset.empty_form.description.label_tag }}
                    {{ experience_formset.empty_form.description }}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="skill-empty-form" style="display: none;">
    <div class="col-md-4 mb-3 skill-form">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body bg-light rounded">
               {{ skill_formset.empty_form.id }}
               <div class="d-flex justify-content-between align-items-center mb-2">
                   <span class="text-muted small">Skill #<span class="entry-number">__number__</span></span>
                   <button type="button" class="btn btn-link text-secondary p-0 remove-form-btn" title="Remove">
                       <i class="bi bi-x-circle fs-6"></i>
                   </button>
               </div>
               <div class="delete-checkbox">{{ skill_formset.empty_form.DELETE }}</div>
               <div class="mb-2">
                   {{ skill_formset.empty_form.name.label_tag }}
                   {{ skill_formset.empty_form.name }}
               </div>
                <div class="mb-2">
                   {{ skill_formset.empty_form.proficiency.label_tag }}
                   {{ skill_formset.empty_form.proficiency }}
               </div>
            </div>
        </div>
<div id="research-empty-form" style="display: none;">
    <div class="card mb-3 border-0 shadow-sm research-form">
        <div class="card-body bg-light rounded">
            {{ research_formset.empty_form.id }}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-muted">Research #<span class="entry-number">__number__</span></h5>
                <button type="button" class="btn btn-link text-secondary p-0 remove-form-btn" title="Remove">
                    <i class="bi bi-x-circle-fill fs-5"></i> Remove
                </button>
            </div>
            <div class="delete-checkbox">{{ research_formset.empty_form.DELETE }}</div>
            <div class="row g-3">
                <div class="col-md-8">
                    {{ research_formset.empty_form.title.label_tag }}
                    {{ research_formset.empty_form.title }}
                </div>
                <div class="col-md-4">
                    {{ research_formset.empty_form.date.label_tag }}
                    {{ research_formset.empty_form.date }}
                </div>
                <div class="col-12">
                    {{ research_formset.empty_form.description.label_tag }}
                    {{ research_formset.empty_form.description }}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="publication-empty-form" style="display: none;">
    <div class="card mb-3 border-0 shadow-sm publication-form">
        <div class="card-body bg-light rounded">
            {{ publication_formset.empty_form.id }}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-muted">Publication #<span class="entry-number">__number__</span></h5>
                <button type="button" class="btn btn-link text-secondary p-0 remove-form-btn" title="Remove">
                    <i class="bi bi-x-circle-fill fs-5"></i> Remove
                </button>
            </div>
            <div class="delete-checkbox">{{ publication_formset.empty_form.DELETE }}</div>
            <div class="row g-3">
                <div class="col-md-6">
                    {{ publication_formset.empty_form.title.label_tag }}
                    {{ publication_formset.empty_form.title }}
                </div>
                <div class="col-md-6">
                    {{ publication_formset.empty_form.publisher.label_tag }}
                    {{ publication_formset.empty_form.publisher }}
                </div>
                <div class="col-md-6">
                    {{ publication_formset.empty_form.date.label_tag }}
                    {{ publication_formset.empty_form.date }}
                </div>
                <div class="col-md-6">
                    {{ publication_formset.empty_form.url.label_tag }}
                    {{ publication_formset.empty_form.url }}
                </div>
            </div>
        </div>
    </div>
</div>

<div id="award-empty-form" style="display: none;">
    <div class="card mb-3 border-0 shadow-sm award-form">
        <div class="card-body bg-light rounded">
            {{ award_formset.empty_form.id }}
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0 text-muted">Award #<span class="entry-number">__number__</span></h5>
                <button type="button" class="btn btn-link text-secondary p-0 remove-form-btn" title="Remove">
                    <i class="bi bi-x-circle-fill fs-5"></i> Remove
                </button>
            </div>
            <div class="delete-checkbox">{{ award_formset.empty_form.DELETE }}</div>
            <div class="row g-3">
                <div class="col-md-6">
                    {{ award_formset.empty_form.title.label_tag }}
                    {{ award_formset.empty_form.title }}
                </div>
                <div class="col-md-6">
                    {{ award_formset.empty_form.issuer.label_tag }}
                    {{ award_formset.empty_form.issuer }}
                </div>
                <div class="col-md-4">
                    {{ award_formset.empty_form.date.label_tag }}
                    {{ award_formset.empty_form.date }}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        function reindexForms(containerId, prefix) {
            const container = document.getElementById(containerId);
            const forms = container.querySelectorAll(`.${prefix}-form`);
            const totalForms = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
            
            // Only re-index forms that are NOT marked for deletion (not hidden)
            // Actually, we should re-index all but focus on visible ones if they were new
            // But Django expects indexes to be contiguous from 0 to TOTAL_FORMS - 1
            // If we remove a form from DOM, we MUST re-index the others.
            
            let visibleIndex = 0;
            forms.forEach((form, index) => {
                if (form.style.display !== 'none') {
                    const entryNumber = form.querySelector('.entry-number');
                    if (entryNumber) entryNumber.textContent = visibleIndex + 1;
                    visibleIndex++;
                }
                
                // Update names and IDs
                const inputs = form.querySelectorAll('input, select, textarea');
                inputs.forEach(input => {
                    if (input.name) input.name = input.name.replace(/-\d+-/, `-${index}-`);
                    if (input.id) input.id = input.id.replace(/-\d+-/, `-${index}-`);
                });
                const labels = form.querySelectorAll('label');
                labels.forEach(label => {
                    if (label.getAttribute('for')) {
                        label.setAttribute('for', label.getAttribute('for').replace(/-\d+-/, `-${index}-`));
                    }
                });
            });
            // Total forms should stay the same if we just hide, but decrease if we delete from DOM
            // However, it's safer to always keep TOTAL_FORMS matching the number of form blocks in DOM
            totalForms.value = forms.length;
        }

        function addForm(btnId, containerId, emptyFormId, prefix) {
            const addBtn = document.getElementById(btnId);
            const container = document.getElementById(containerId);
            const emptyForm = document.getElementById(emptyFormId);

            addBtn.addEventListener('click', function() {
                const totalForms = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
                const currentForms = parseInt(totalForms.value);
                const newFormHtml = emptyForm.innerHTML
                    .replace(/__prefix__/g, currentForms)
                    .replace(/__number__/g, currentForms + 1);
                
                if (prefix === 'skills') {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = newFormHtml;
                    container.appendChild(tempDiv.firstElementChild);
                } else {
                    container.insertAdjacentHTML('beforeend', newFormHtml);
                }
                
                totalForms.value = currentForms + 1;
                reindexForms(containerId, prefix);
            });
        }

        // Global event delegation for remove buttons
        document.addEventListener('click', function(e) {
            const btn = e.target.closest('.remove-form-btn');
            if (btn) {
                const formBlock = btn.closest('.education-form, .experience-form, .skill-form, .research-form, .publication-form, .award-form');
                if (!formBlock) return;
                
                let containerId, prefix;
                if (formBlock.classList.contains('education-form')) { containerId = 'education-formset'; prefix = 'education'; }
                else if (formBlock.classList.contains('experience-form')) { containerId = 'experience-formset'; prefix = 'experience'; }
                else if (formBlock.classList.contains('skill-form')) { containerId = 'skill-formset'; prefix = 'skills'; }
                else if (formBlock.classList.contains('research-form')) { containerId = 'research-formset'; prefix = 'research'; }
                else if (formBlock.classList.contains('publication-form')) { containerId = 'publication-formset'; prefix = 'publication'; }
                else if (formBlock.classList.contains('award-form')) { containerId = 'award-formset'; prefix = 'award'; }

                const idInput = formBlock.querySelector('input[name$="-id"]');
                if (idInput && idInput.value) {
                    // Existing entry: mark for deletion and hide
                    const deleteCheckbox = formBlock.querySelector('input[name$="-DELETE"]');
                    if (deleteCheckbox) deleteCheckbox.checked = true;
                    formBlock.style.display = 'none';
                } else {
                    // New entry: remove from DOM
                    formBlock.remove();
                }
                reindexForms(containerId, prefix);
            }
        });

        addForm('add-education', 'education-formset', 'education-empty-form', 'education');
        addForm('add-experience', 'experience-formset', 'experience-empty-form', 'experience');
        addForm('add-skill', 'skill-formset', 'skill-empty-form', 'skills');
        
        const addResearchBtn = document.getElementById('add-research');
        if (addResearchBtn) addForm('add-research', 'research-formset', 'research-empty-form', 'research');
        
        const addPubBtn = document.getElementById('add-publication');
        if (addPubBtn) addForm('add-publication', 'publication-formset', 'publication-empty-form', 'publication');
        
        const addAwardBtn = document.getElementById('add-award');
        if (addAwardBtn) addForm('add-award', 'award-formset', 'award-empty-form', 'award');

        // Preview Tab Logic
        const templateSelect = document.querySelector('select[name="template_name"]'); // Ensure field name is correct
        // If template_name field has a different ID or Name (ResumeForm usually uses template_name), check it.
        // Assuming 'template_name' is the field name.
        const previewFrame = document.getElementById('previewFrame');
        if (templateSelect && previewFrame) {
            templateSelect.addEventListener('change', function() {
                const selectedTemplate = this.value;
                try {
                    const currentSrc = new URL(previewFrame.src);
                    currentSrc.searchParams.set('template', selectedTemplate);
                    previewFrame.src = currentSrc.toString();
                } catch (e) {
                    console.error("Invalid URL in preview frame");
                }
            });
        }
        
        const addAwardBtn = document.getElementById('add-award');
        if (addAwardBtn) addForm('add-award', 'award-formset', 'award-empty-form', 'award');
    });
</script>
{% endblock %}
